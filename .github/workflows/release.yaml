name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  actions: read

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      released: ${{ steps.release.outputs.released }}
      version: ${{ steps.release.outputs.version }}
      tag: ${{ steps.release.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Authenticate as GitHub App
        id: auth
        uses: ./.github/actions/github-app-auth
        with:
          app-id: ${{ secrets.AUTOMATION_GITHUB_APP_ID }}
          private-key: ${{ secrets.AUTOMATION_GITHUB_APP_PRIVATE_KEY }}

      - name: Fetch tags
        run: git fetch --tags --force

      - name: Setup mise
        uses: jdx/mise-action@v2

      - name: Install dependencies
        run: yarn install

      - name: Run release-it
        id: release
        run: |
          # Run release-it to bump version, update changelog, commit, and tag
          if yarn release-it --ci; then
            echo "released=true" >> "$GITHUB_OUTPUT"
            # Get version from the latest git tag (created by release-it)
            TAG=$(git describe --tags --abbrev=0)
            VERSION="${TAG#v}"
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          else
            echo "No release created"
            echo "released=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub release
        if: steps.release.outputs.released == 'true'
        run: |
          gh release create "${{ steps.release.outputs.tag }}" \
            bin/git-wt \
            --title "${{ steps.release.outputs.tag }}" \
            --generate-notes

  # NOTE: Homebrew formula updates are handled by Renovate in nsheaps/homebrew-devsetup

